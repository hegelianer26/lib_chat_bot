<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <script src="https://cdn.tiny.cloud/1/v48jrck1j9l25ljqjd19zuxjy9g3fletyxhjnhzhjlj2ltz2/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <title>–î–∏–∞–ª–æ–≥–∏</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <!-- Select2 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
    <!-- jQuery (–Ω–µ–æ–±—Ö–æ–¥–∏–º –¥–ª—è Select2) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!-- Select2 JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.full.min.js"></script>

</head>
<body>
    
    <nav class="navbar">
        <ul class="navbar-list">
            <li class="navbar-item"><a href="/config" class="navbar-link">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Ç–∞</a></li>
            <li class="navbar-item"><a href="/dialogs" class="navbar-link">–î–∏–∞–ª–æ–≥–∏</a></li>
            <li class="navbar-item"><a href="/statistics" class="navbar-link">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a></li>
            <li class="navbar-item"><a href="/users" class="navbar-link">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</a></li>
        </ul>
    </nav>
    
    {% macro render_category_tree(categories, parent_id=None, prefix="", level=0) %}
    {% for category in categories %}
        {% if category.parent_id == parent_id %}
            {% if level == 0 %}
                <option value="{{ category.id }}">üóÇÔ∏è {{ category.name }}</option>
            {% else %}
                <option value="{{ category.id }}">{{ prefix }} {{ category.name }}</option>
            {% endif %}
            {% if category.children %}
                {{ render_category_tree(categories, category.id, prefix + "----", level + 1) }}
            {% endif %}
        {% endif %}
    {% endfor %}
{% endmacro %}

    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞–º–∏</h1>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ -->
    <div class="form-section">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</h2>
        <form method="POST">
            <input type="hidden" name="action" value="add_category">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:
                <input type="text" name="category_name" placeholder="–ö–∞—Ç–µ–≥–æ—Ä–∏—è" required>
            </label>
            <label>–†–æ–¥–∏—Ç–µ–ª—å—Å–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è:
                <select name="parent_id" class="category-select">
                    <option value="">(–±–µ–∑ —Ä–æ–¥–∏—Ç–µ–ª—è)</option>
                    {{ render_category_tree(categories) }}
                </select>
                
            </label>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å</button>
        </form>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ -->
    <div class="form-section">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</h2>
        <form method="POST" enctype="multipart/form-data">
            <input type="hidden" name="action" value="add_answer">
            <label>–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞:
                <textarea name="answer_text" cols="40" rows="3" placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞" required></textarea>
            </label>
            <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:
                <select name="category_id">
                    {% for c in categories %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </label>
            <label>–§–æ—Ç–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
                <input type="file" name="answer_image" accept="image/*">
            </label>
            <button type="submit">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
        </form>
    </div>

    {% macro render_category_tree(category) %}
    <li>
        {% set has_children = category.children|length > 0 %}
        {% set has_answers = category.answers|length > 0 %}

        {% if has_children or has_answers %}
            <span class="toggle-btn" onclick="toggleSubtree(this)">[+]</span>
        {% else %}
            <span class="toggle-btn"></span>
        {% endif %}

        <span class="category-name">#{{ category.id }} {{ category.name }}</span>

        <form method="POST" class="inline-form">
            <input type="hidden" name="action" value="delete_category">
            <input type="hidden" name="cat_id" value="{{ category.id }}">
            <button type="submit" class="btn-delete">–£–¥–∞–ª–∏—Ç—å</button>
        </form>

        <form method="POST" class="inline-form">
            <input type="hidden" name="action" value="edit_category">
            <input type="hidden" name="cat_id" value="{{ category.id }}">
            <input type="text" name="new_name" class="edit-field" placeholder="–ù–æ–≤–æ–µ –∏–º—è">
            <button type="submit">–ò–∑–º.</button>
        </form>

        {% if has_children or has_answers %}
            <ul class="subcategory hidden">
                {% if has_answers %}
                    <div class="answers-block">
                        {% for ans in category.answers %}
                        <div class="answer-content">
                            <strong>–û—Ç–≤–µ—Ç #{{ ans.id }}</strong>
                            <div id="view-answer-{{ ans.id }}">
                                <p>{{ ans.text }}</p>
                                <form method="POST" class="inline-form">
                                    <input type="hidden" name="action" value="delete_answer">
                                    <input type="hidden" name="ans_id" value="{{ ans.id }}">
                                    <button type="submit" class="btn-delete-answer">–£–¥–∞–ª–∏—Ç—å</button>
                                </form>
                                <button onclick="showEditForm({{ ans.id }})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                            </div>
                            <div id="edit-form-{{ ans.id }}" style="display: none;">
                                <form method="POST" class="edit-answer-form" enctype="multipart/form-data">
                                    <input type="hidden" name="action" value="edit_answer">
                                    <input type="hidden" name="ans_id" value="{{ ans.id }}">
                                    <textarea id="edit-answer-{{ ans.id }}" name="new_text">{{ ans.text }}</textarea>
                                    <input type="file" name="new_image" class="image-input">
                                    <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                    <button type="button" onclick="hideEditForm({{ ans.id }})">–û—Ç–º–µ–Ω–∞</button>
                                </form>
                            </div>
                            
                            {% if ans.image_path %}
                            <div class="image-container">
                                <img src="{{ url_for('static', filename=ans.image_path.replace('static/', '')) }}" 
                                     class="answer-thumbnail" 
                                     onclick="showFullImage(this.src)"
                                     alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞">
                                <form method="POST" class="inline-form">
                                    <input type="hidden" name="action" value="delete_image">
                                    <input type="hidden" name="ans_id" value="{{ ans.id }}">
                                    <button type="submit" class="btn-delete-photo">–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ</button>
                                </form>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}

                {% for child_cat in category.children %}
                    {{ render_category_tree(child_cat) }}
                {% endfor %}
            </ul>
        {% endif %}
    </li>
    {% endmacro %}

    <div class="form-section">
        <h2>–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–π</h2>
        <div class="toggle-buttons">
            <button onclick="collapseAll()">–°–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
            <button onclick="expandAll()">–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ</button>
        </div>
        <ul class="category-tree">
            {% for root_cat in root_categories %}
                {{ render_category_tree(root_cat) }}
            {% endfor %}
        </ul>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
    <div id="imageModal" class="modal">
        <span class="modal-close" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modalImage">
    </div>
    <script src="{{ url_for('static', filename='js/scripts.js') }}"></script>
    
</body>
</html>